<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K-nearest neighbour adaptive bandwidth • spNetwork</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="K-nearest neighbour adaptive bandwidth">
<meta property="og:description" content="spNetwork">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">spNetwork</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/web_vignettes/AdaptiveBW.html">K-nearest neighbour adaptive bandwidth</a>
    </li>
    <li>
      <a href="../../articles/web_vignettes/Isochrones.html">Calculating isochrones</a>
    </li>
    <li>
      <a href="../../articles/KNetworkFunctions.html">Network k Functions</a>
    </li>
    <li>
      <a href="../../articles/NetworkBuilding.html">Building graphs</a>
    </li>
    <li>
      <a href="../../articles/NKDE.html">Network Kernel Density Estimate</a>
    </li>
    <li>
      <a href="../../articles/web_vignettes/NKDEdetailed.html">Details about NKDE</a>
    </li>
    <li>
      <a href="../../articles/web_vignettes/SpaceTimeDBscan.html">Spatio-temporal dbscan with network distance</a>
    </li>
    <li>
      <a href="../../articles/SpatialWeightMatrices.html">Spatial Weight Matrices</a>
    </li>
    <li>
      <a href="../../articles/web_vignettes/SpeedVSprecision.html">Analysing the impact of max_dept parameter for continuous NKDE</a>
    </li>
    <li>
      <a href="../../articles/TNKDE.html">Temporal Network Kernel Density Estimate</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JeremyGelb/spNetwork/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>K-nearest neighbour adaptive bandwidth</h1>
                        <h4 data-toc-skip class="author">Jeremy
Gelb</h4>
            
            <h4 data-toc-skip class="date">2024-10-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JeremyGelb/spNetwork/blob/HEAD/vignettes/web_vignettes/AdaptiveBW.Rmd" class="external-link"><code>vignettes/web_vignettes/AdaptiveBW.Rmd</code></a></small>
      <div class="hidden name"><code>AdaptiveBW.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>As stated in the vignette (<em>Network Kernel Density Estimate</em>),
it is possible to use adaptive bandwidths instead of a fixed bandwidth
to adapt the level of smoothing of the NKDE locally. The default
approach is to use the method proposed by <span class="citation">Abramson (<a href="#ref-abramson1982bandwidth">1982</a>)</span>, implying a variation
of the bandwidth that is inversely proportional to the square root of
the target density itself. However, one can also specified the
bandwidths to use for each event directly and thus try other approaches.
We give in this vignette some examples.</p>
</div>
<div class="section level2">
<h2 id="k-nearest-neighbours-adaptive-bandwidth-for-nkde">K nearest neighbours adaptive bandwidth for NKDE<a class="anchor" aria-label="anchor" href="#k-nearest-neighbours-adaptive-bandwidth-for-nkde"></a>
</h2>
<p>For each event, the K nearest neighbour distance could be used as a
locally adapted bandwidth for intensity estimation. This method is
called the k-nearest neighbour kernel density estimation method <span class="citation">(<a href="#ref-loftsgaarden_nonparametric_1965">Loftsgaarden and Quesenberry
1965</a>; <a href="#ref-terrell_variable_1992">Terrell and Scott
1992</a>; <a href="#ref-orava_k-nearest_2011">Orava
2011</a>)</span>.</p>
<p>To apply it in <code>spNetwork</code>, one can use the
<code>network_knn</code> function. The first step is to load the
required packages and data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first load data and packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jeremygelb.github.io/spNetwork/" class="external-link">spNetwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/" class="external-link">tmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/classInt/" class="external-link">classInt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mtl_network</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span></span></code></pre></div>
<p>We must then aggregate the events that are very close.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">bike_accidents_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/aggregate_points.html">aggregate_points</a></span><span class="op">(</span><span class="va">bike_accidents</span>, <span class="fl">15</span>, weight <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span></span></code></pre></div>
<p>We can now calculate for each event its distance to its 30th
neighbour.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knn_dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/network_knn.html">network_knn</a></span><span class="op">(</span>origins <span class="op">=</span> <span class="va">bike_accidents_agg</span>, </span>
<span>                         lines <span class="op">=</span> <span class="va">mtl_network</span>, </span>
<span>                         k <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                         maxdistance <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                         line_weight <span class="op">=</span> <span class="st">"length"</span>,</span>
<span>                         digits <span class="op">=</span> <span class="fl">2</span>, tol <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bws</span> <span class="op">&lt;-</span> <span class="va">knn_dists</span><span class="op">$</span><span class="va">distances</span><span class="op">[</span>,<span class="fl">20</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bws</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="st">"black"</span>, bins <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"distance to 20th neighbour (m)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="AdaptiveBW_files/figure-html/unnamed-chunk-3-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>There is some events for which the 20th neighbour is very far. We
decide here to trim the bandwidth at 1500m.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">trimed_bw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">bws</span> <span class="op">&gt;</span> <span class="fl">1500</span>, <span class="fl">1500</span>, <span class="va">bws</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/lixelize_lines.html">lixelize_lines</a></span><span class="op">(</span><span class="va">mtl_network</span>,<span class="fl">200</span>,mindist <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/lines_center.html">lines_center</a></span><span class="op">(</span><span class="va">lixels</span><span class="op">)</span></span>
<span></span>
<span><span class="va">densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/nkde.html">nkde</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,</span>
<span>                  events <span class="op">=</span> <span class="va">bike_accidents_agg</span>,</span>
<span>                  w <span class="op">=</span> <span class="va">bike_accidents_agg</span><span class="op">$</span><span class="va">weight</span>,</span>
<span>                  samples <span class="op">=</span> <span class="va">samples</span>,</span>
<span>                  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>,</span>
<span>                  bw <span class="op">=</span> <span class="va">trimed_bw</span>,</span>
<span>                  div<span class="op">=</span> <span class="st">"bw"</span>,</span>
<span>                  adaptive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"discontinuous"</span>,</span>
<span>                  digits <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  tol <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  diggle_correction <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  study_area <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                  max_depth <span class="op">=</span> <span class="fl">10</span>, agg <span class="op">=</span> <span class="cn">NULL</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can now map the result</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># rescaling to help the mapping</span></span>
<span><span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">densities</span><span class="op">*</span><span class="fl">1000</span></span>
<span></span>
<span><span class="va">colorRamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">7</span>, name <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span></span>
<span><span class="va">colorRamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">colorRamp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">samples2</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">density</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bike accident density by kilometres in 2016,"</span>,</span>
<span>                <span class="st">"\nusing an adaptive bandwidth (20th nearest neighbour)"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">mtl_network</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">samples2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span><span class="st">"density"</span>, style <span class="op">=</span> <span class="st">"kmeans"</span>, palette <span class="op">=</span> <span class="va">colorRamp</span>, n <span class="op">=</span> <span class="fl">7</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span>legend.outside <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>            main.title <span class="op">=</span> <span class="va">title</span>, main.title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="AdaptiveBW_files/figure-html/unnamed-chunk-5-1.png" width="768" style="display: block; margin: auto;"></p>
<p>It is easy to calculate the density for several distances and
comparing the results with maps.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># calculating all the densities</span></span>
<span><span class="va">all_densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span>,<span class="fl">15</span>,<span class="fl">20</span>,<span class="fl">25</span>,<span class="fl">30</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">bws</span> <span class="op">&lt;-</span> <span class="va">knn_dists</span><span class="op">$</span><span class="va">distances</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">upper_trim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">bws</span>, probs <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span>  <span class="va">trimed_bws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">bws</span> <span class="op">&gt;</span> <span class="va">upper_trim</span>, <span class="va">upper_trim</span>, <span class="va">bws</span><span class="op">)</span></span>
<span>  <span class="va">densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/nkde.html">nkde</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,</span>
<span>                  events <span class="op">=</span> <span class="va">bike_accidents_agg</span>,</span>
<span>                  w <span class="op">=</span> <span class="va">bike_accidents_agg</span><span class="op">$</span><span class="va">weight</span>,</span>
<span>                  samples <span class="op">=</span> <span class="va">samples</span>,</span>
<span>                  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>,</span>
<span>                  bw <span class="op">=</span> <span class="va">trimed_bws</span>,</span>
<span>                  div<span class="op">=</span> <span class="st">"bw"</span>,</span>
<span>                  adaptive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"discontinuous"</span>,</span>
<span>                  digits <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  tol <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  diggle_correction <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  study_area <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                  max_depth <span class="op">=</span> <span class="fl">10</span>, agg <span class="op">=</span> <span class="cn">NULL</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"dens"</span> <span class="op">=</span> <span class="va">densities</span>,</span>
<span>              <span class="st">"knn"</span> <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calculating a shared discretization</span></span>
<span><span class="co">#all_values &lt;- c(sapply(all_densities, function(x){x$dens}))</span></span>
<span><span class="co">#color_breaks &lt;- classIntervals(all_values * 1000, n = 7, style = "kmeans")</span></span>
<span></span>
<span><span class="co"># producing all the maps</span></span>
<span><span class="va">all_maps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">all_densities</span>, <span class="kw">function</span><span class="op">(</span><span class="va">element</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">densities</span> <span class="op">&lt;-</span> <span class="va">element</span><span class="op">$</span><span class="va">dens</span></span>
<span>  <span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">densities</span><span class="op">*</span><span class="fl">1000</span></span>
<span>  </span>
<span>  <span class="va">samples2</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">density</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bike accident density by kilometres in 2016,"</span>,</span>
<span>                  <span class="st">"\nusing an adaptive bandwidth ("</span>,<span class="va">element</span><span class="op">$</span><span class="va">knn</span>,<span class="st">"th nearest neighbour)"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">knnmap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">mtl_network</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">samples2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co">#tm_dots("density", breaks = color_breaks$brks, palette = viridis(7), size = 0.05) +</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span><span class="st">"density"</span>, n <span class="op">=</span> <span class="fl">7</span>, style <span class="op">=</span> <span class="st">"kmeans"</span>, palette <span class="op">=</span> <span class="va">colorRamp</span> , size <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span>legend.outside <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>              main.title <span class="op">=</span> <span class="va">title</span>, main.title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">knnmap</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_animation.html" class="external-link">tmap_animation</a></span><span class="op">(</span><span class="va">all_maps</span>, filename <span class="op">=</span> <span class="st">"images/animated_densities.gif"</span>,</span>
<span>               width <span class="op">=</span> <span class="fl">800</span>, height <span class="op">=</span> <span class="fl">800</span>, dpi <span class="op">=</span> <span class="fl">150</span>, delay <span class="op">=</span> <span class="fl">200</span>, loop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Creating frames</span></span>
<span><span class="co">#&gt; =============</span></span>
<span><span class="co">#&gt; ==============</span></span>
<span><span class="co">#&gt; =============</span></span>
<span><span class="co">#&gt; =============</span></span>
<span><span class="co">#&gt; ==============</span></span>
<span><span class="co">#&gt; =============</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Creating animation</span></span>
<span><span class="co">#&gt; Animation saved to E:\R\Packages\spNetwork\vignettes\web_vignettes\images\animated_densities.gif</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"images/animated_densities.gif"</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/animated_densities.gif" width="100%" style="display: block; margin: auto;"></p>
<p>With no suprise, the larger the bandwidth, the smoother the
results</p>
<div class="section level3">
<h3 id="finding-the-optimal-bandwidth">Finding the optimal bandwidth<a class="anchor" aria-label="anchor" href="#finding-the-optimal-bandwidth"></a>
</h3>
<p>To complete the visual inspection we did above, we could select an
optimal set of local bandwidths by using the likelihood cross validation
criterion. To do so, we can use the function
<code>bw_cv_likelihood_calc</code> and we must create a matrix of
bandwidths that will be evaluated.</p>
<p>We will compare below the scores obtained for the local bandwidths
based on the 5th to 25th nearest neighbours.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">nearest_nb_mat</span> <span class="op">&lt;-</span> <span class="va">knn_dists</span><span class="op">$</span><span class="va">distances</span><span class="op">[</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">25</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">nearest_nb_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">5</span><span class="op">:</span><span class="fl">25</span></span>
<span></span>
<span><span class="va">bw_scores_dis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/bw_cv_likelihood_calc.html">bw_cv_likelihood_calc</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,</span>
<span>                                   events <span class="op">=</span> <span class="va">bike_accidents_agg</span>,</span>
<span>                                   w <span class="op">=</span> <span class="va">bike_accidents_agg</span><span class="op">$</span><span class="va">weight</span>,</span>
<span>                                   kernel_name <span class="op">=</span> <span class="st">'quartic'</span>,</span>
<span>                                   method <span class="op">=</span> <span class="st">'discontinuous'</span>,</span>
<span>                                   adaptive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                   mat_bws <span class="op">=</span> <span class="va">nearest_nb_mat</span>,</span>
<span>                                   digits <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                   tol <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>                                   grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                   max_depth <span class="op">=</span> <span class="fl">8</span>, agg <span class="op">=</span> <span class="cn">NULL</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "checking inputs ..."</span></span>
<span><span class="co">#&gt; [1] "prior data preparation ..."</span></span>
<span><span class="co">#&gt; [1] "Calculating the correction factor if required"</span></span>
<span><span class="co">#&gt; [1] "Splittig the dataset within the grid ..."</span></span>
<span><span class="co">#&gt; [1] "start calculating the CV values ..."</span></span>
<span><span class="co">#&gt;   |                                                                              |                                                                      |   0%[1] 1</span></span>
<span><span class="co">#&gt;   |                                                                              |==================                                                    |  25%[1] 2</span></span>
<span><span class="co">#&gt;   |                                                                              |===================================                                   |  50%[1] 3</span></span>
<span><span class="co">#&gt;   |                                                                              |====================================================                  |  75%[1] 4</span></span>
<span><span class="co">#&gt;   |                                                                              |======================================================================| 100%</span></span>
<span></span>
<span><span class="va">bw_scores_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/bw_cv_likelihood_calc.html">bw_cv_likelihood_calc</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,</span>
<span>                                   events <span class="op">=</span> <span class="va">bike_accidents_agg</span>,</span>
<span>                                   w <span class="op">=</span> <span class="va">bike_accidents_agg</span><span class="op">$</span><span class="va">weight</span>,</span>
<span>                                   kernel_name <span class="op">=</span> <span class="st">'quartic'</span>,</span>
<span>                                   method <span class="op">=</span> <span class="st">'continuous'</span>,</span>
<span>                                   adaptive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                   mat_bws <span class="op">=</span> <span class="va">nearest_nb_mat</span>,</span>
<span>                                   digits <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                   tol <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>                                   grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                   max_depth <span class="op">=</span> <span class="fl">8</span>, agg <span class="op">=</span> <span class="cn">NULL</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "checking inputs ..."</span></span>
<span><span class="co">#&gt; [1] "prior data preparation ..."</span></span>
<span><span class="co">#&gt; [1] "Calculating the correction factor if required"</span></span>
<span><span class="co">#&gt; [1] "Splittig the dataset within the grid ..."</span></span>
<span><span class="co">#&gt; [1] "start calculating the CV values ..."</span></span>
<span><span class="co">#&gt;   |                                                                              |                                                                      |   0%[1] 1</span></span>
<span><span class="co">#&gt;   |                                                                              |==================                                                    |  25%[1] 2</span></span>
<span><span class="co">#&gt;   |                                                                              |===================================                                   |  50%[1] 3</span></span>
<span><span class="co">#&gt;   |                                                                              |====================================================                  |  75%[1] 4</span></span>
<span><span class="co">#&gt;   |                                                                              |======================================================================| 100%</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  k <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">25</span>,</span>
<span>  score_dis <span class="op">=</span> <span class="va">bw_scores_dis</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>  score_cont <span class="op">=</span> <span class="va">bw_scores_cont</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_dis</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_dis</span>, color <span class="op">=</span> <span class="st">'discontinuous'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_cont</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_cont</span>, color <span class="op">=</span> <span class="st">'continuous'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"discontinuous"</span> <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                                <span class="st">"continuous"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">''</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="AdaptiveBW_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Based on these results, we decide to use the 8th nearest neighbour as
an optimal bandwidth. It clearly maximizes the likelihood cross
validation criterion for both the continuous and the discontinuous
NKDE.</p>
</div>
</div>
<div class="section level2">
<h2 id="k-nearest-neighbours-adaptive-bandwidth-for-tnkde">K nearest neighbours adaptive bandwidth for TNKDE<a class="anchor" aria-label="anchor" href="#k-nearest-neighbours-adaptive-bandwidth-for-tnkde"></a>
</h2>
<p>This method can be extended to the spatio-temporal case. We propose
here a two-steps approach:</p>
<ol style="list-style-type: decimal">
<li>Finding for each event its 20 nearest neighbours on the network. The
distance to the last neighbour will be the local network bandwidth for
this event.</li>
<li>Within the selected neighbours, calculating the median of the
temporal distances with the event. This value will be used as the local
time bandwidth for this event.</li>
</ol>
<p>This approach ensures that relatively small network bandwidths are
selected, and limits the risk of obtaining very wide temporal
bandwidths. It is well adapted if the events are characterized by strong
spatio-temporal autocorrelation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># creating a time variable</span></span>
<span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">Date</span>, format <span class="op">=</span> <span class="st">"%Y/%m/%d"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># associating each original event with its new location</span></span>
<span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">locID</span> <span class="op">&lt;-</span> <span class="fu">dbscan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/kNN.html" class="external-link">kNN</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">bike_accidents_agg</span><span class="op">)</span>,</span>
<span>            k <span class="op">=</span> <span class="fl">1</span>, query <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># matrix of all reached agg events</span></span>
<span><span class="va">ids_mat</span> <span class="op">&lt;-</span> <span class="va">knn_dists</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="co"># finding for each event its temporal distance to its neighbours</span></span>
<span><span class="va">bike_accidents_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span></span>
<span></span>
<span><span class="va">temporal_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents_table</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">loc_ids</span> <span class="op">&lt;-</span> <span class="va">ids_mat</span><span class="op">[</span><span class="va">bike_accidents_table</span><span class="op">[</span><span class="va">i</span>,<span class="st">"locID"</span><span class="op">]</span>,<span class="op">]</span></span>
<span>  <span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">bike_accidents_table</span>, <span class="va">bike_accidents_table</span><span class="op">$</span><span class="va">locID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">loc_ids</span><span class="op">)</span></span>
<span>  <span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">bike_accidents_table</span><span class="op">[</span><span class="va">i</span>,<span class="st">"time"</span><span class="op">]</span>, <span class="va">events</span><span class="op">$</span><span class="va">time</span>, units <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dists</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating the medians</span></span>
<span><span class="va">medians</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">temporal_mat</span>,<span class="va">median</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">medians</span><span class="op">)</span>, bins <span class="op">=</span> <span class="fl">30</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p><img src="AdaptiveBW_files/figure-html/unnamed-chunk-9-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Once again, we could trim the obtained bandwidths and setting a limit
at 120 days (4 months).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trimed_bws_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">medians</span> <span class="op">&gt;</span> <span class="fl">120</span>, <span class="fl">120</span>, <span class="va">medians</span><span class="op">)</span></span></code></pre></div>
<p>And we can now calculate the TNKDE with these bandwidths:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">net_bws</span> <span class="op">&lt;-</span> <span class="va">knn_dists</span><span class="op">$</span><span class="va">distance</span><span class="op">[</span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">locID</span>,<span class="fl">20</span><span class="op">]</span></span>
<span><span class="va">trimed_net_bws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">net_bws</span> <span class="op">&gt;</span> <span class="fl">1500</span>, <span class="fl">1500</span>, <span class="va">net_bws</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">int_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">time</span>, </span>
<span>                                               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>,</span>
<span>                                               units <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">int_time</span><span class="op">)</span>, <span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tnkde_densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/tnkde.html">tnkde</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,</span>
<span>                  events <span class="op">=</span> <span class="va">bike_accidents</span>,</span>
<span>                  time_field <span class="op">=</span> <span class="st">"int_time"</span>,</span>
<span>                  w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  samples_loc <span class="op">=</span> <span class="va">samples</span>,</span>
<span>                  samples_time <span class="op">=</span> <span class="va">sample_time</span>,</span>
<span>                  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>,</span>
<span>                  bw_net <span class="op">=</span> <span class="va">trimed_net_bws</span>,</span>
<span>                  bw_time <span class="op">=</span> <span class="va">trimed_bws_time</span>,</span>
<span>                  div<span class="op">=</span> <span class="st">"bw"</span>,</span>
<span>                  adaptive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"discontinuous"</span>,</span>
<span>                  digits <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  tol <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  diggle_correction <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  study_area <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                  max_depth <span class="op">=</span> <span class="fl">10</span>, agg <span class="op">=</span> <span class="cn">NULL</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can now create an animated map to display the results:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># creating a color palette for all the densities</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/classInt/" class="external-link">classInt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span><span class="va">all_densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tnkde_densities</span><span class="op">)</span></span>
<span><span class="va">color_breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/classInt/reference/classIntervals.html" class="external-link">classIntervals</a></span><span class="op">(</span><span class="va">all_densities</span>, n <span class="op">=</span> <span class="fl">10</span>, style <span class="op">=</span> <span class="st">"kmeans"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generating a map at each sample time</span></span>
<span><span class="va">all_maps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">tnkde_densities</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">time</span> <span class="op">&lt;-</span> <span class="va">sample_time</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">start</span><span class="op">)</span> <span class="op">+</span> <span class="va">time</span></span>
<span>  </span>
<span>  <span class="va">lixels</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">tnkde_densities</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">lixels</span> <span class="op">&lt;-</span> <span class="va">lixels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">lixels</span><span class="op">$</span><span class="va">density</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="va">map1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">lixels</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"density"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>          breaks <span class="op">=</span> <span class="va">color_breaks</span><span class="op">$</span><span class="va">brks</span>, palette <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span>legend.show<span class="op">=</span><span class="cn">FALSE</span>, main.title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, main.title.size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">map1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># creating a gif with all the maps</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_animation.html" class="external-link">tmap_animation</a></span><span class="op">(</span><span class="va">all_maps</span>, filename <span class="op">=</span> <span class="st">"images/animated_map_tnkdeknn.gif"</span>, </span>
<span>               width <span class="op">=</span> <span class="fl">1000</span>, height <span class="op">=</span> <span class="fl">1000</span>, dpi <span class="op">=</span> <span class="fl">300</span>, delay <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"images/animated_map_tnkdeknn.gif"</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/animated_map_tnkdeknn.gif" width="75%" style="display: block; margin: auto;"></p>
<div class="section level3">
<h3 id="finding-the-optimal-bandwidth-1">Finding the optimal bandwidth<a class="anchor" aria-label="anchor" href="#finding-the-optimal-bandwidth-1"></a>
</h3>
<p>To find the optimal bandwidth, we can use again the likelihood cross
validation criterion. We need to create an array of bandwidths.</p>
<p>The goal here is to find the number of neihgbours <em>k</em> which
optimizes the likelihood cross validation criterion. So we will have
several nework bandwidths, but only one time bandwidth.</p>
<p>The dimensions of this array must be as follow :
c(network,temporal,events)</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">network_bws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents_table</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_bws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents_table</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we complete the array with the network bandwidths</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents_table</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">id</span> <span class="op">&lt;-</span> <span class="va">bike_accidents_table</span><span class="op">$</span><span class="va">locID</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co"># we get the local network bandwidths</span></span>
<span>  <span class="va">net_bws</span> <span class="op">&lt;-</span> <span class="va">knn_dists</span><span class="op">$</span><span class="va">distance</span><span class="op">[</span><span class="va">id</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">25</span><span class="op">]</span></span>
<span>  <span class="va">network_bws</span><span class="op">[</span>,<span class="fl">1</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">net_bws</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># we complete the array with the time bandwidths</span></span>
<span><span class="va">ii</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">5</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">temporal_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents_table</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">loc_ids</span> <span class="op">&lt;-</span> <span class="va">ids_mat</span><span class="op">[</span><span class="va">bike_accidents_table</span><span class="op">[</span><span class="va">i</span>,<span class="st">"locID"</span><span class="op">]</span>,<span class="fl">1</span><span class="op">:</span><span class="va">j</span><span class="op">]</span></span>
<span>    <span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">bike_accidents_table</span>, <span class="va">bike_accidents_table</span><span class="op">$</span><span class="va">locID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">loc_ids</span><span class="op">)</span></span>
<span>    <span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">bike_accidents_table</span><span class="op">[</span><span class="va">i</span>,<span class="st">"time"</span><span class="op">]</span>, <span class="va">events</span><span class="op">$</span><span class="va">time</span>, units <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dists</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">medians</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">temporal_mat</span>,<span class="va">median</span><span class="op">)</span></span>
<span>  <span class="va">time_bws</span><span class="op">[</span><span class="va">ii</span>,<span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">medians</span></span>
<span>  <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">ii</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">scores_dis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/bw_tnkde_cv_likelihood_calc.html">bw_tnkde_cv_likelihood_calc</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,</span>
<span>                                      events <span class="op">=</span> <span class="va">bike_accidents</span>,</span>
<span>                                      time_field <span class="op">=</span> <span class="st">"int_time"</span>,</span>
<span>                                      w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                      kernel_name <span class="op">=</span> <span class="st">'quartic'</span>,</span>
<span>                                      method <span class="op">=</span> <span class="st">'discontinuous'</span>,</span>
<span>                                      arr_bws_net <span class="op">=</span> <span class="va">network_bws</span>,</span>
<span>                                      arr_bws_time <span class="op">=</span> <span class="va">time_bws</span>,</span>
<span>                                      diggle_correction <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                      study_area <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                      adaptive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                      trim_net_bws <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                      trim_time_bws <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                      max_depth <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                      digits<span class="op">=</span><span class="fl">5</span>,</span>
<span>                                      tol<span class="op">=</span><span class="fl">0.1</span>,</span>
<span>                                      agg<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>                                      sparse<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                      zero_strat <span class="op">=</span> <span class="st">"min_double"</span>,</span>
<span>                                      grid_shape<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                                      sub_sample<span class="op">=</span><span class="fl">1</span>,</span>
<span>                                      verbose<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                                      check<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scores_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/bw_tnkde_cv_likelihood_calc.html">bw_tnkde_cv_likelihood_calc</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,</span>
<span>                                      events <span class="op">=</span> <span class="va">bike_accidents</span>,</span>
<span>                                      time_field <span class="op">=</span> <span class="st">"int_time"</span>,</span>
<span>                                      w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                      kernel_name <span class="op">=</span> <span class="st">'quartic'</span>,</span>
<span>                                      method <span class="op">=</span> <span class="st">'continuous'</span>,</span>
<span>                                      arr_bws_net <span class="op">=</span> <span class="va">network_bws</span>,</span>
<span>                                      arr_bws_time <span class="op">=</span> <span class="va">time_bws</span>,</span>
<span>                                      diggle_correction <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                      study_area <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                      adaptive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                      trim_net_bws <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                      trim_time_bws <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                      max_depth <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                      digits<span class="op">=</span><span class="fl">5</span>,</span>
<span>                                      tol<span class="op">=</span><span class="fl">0.1</span>,</span>
<span>                                      agg<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>                                      sparse<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                      zero_strat <span class="op">=</span> <span class="st">"min_double"</span>,</span>
<span>                                      grid_shape<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                                      sub_sample<span class="op">=</span><span class="fl">1</span>,</span>
<span>                                      verbose<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                                      check<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  k <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">25</span>,</span>
<span>  score_dis <span class="op">=</span> <span class="va">scores_dis</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  score_cont <span class="op">=</span> <span class="va">scores_cont</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_dis</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_dis</span>, color <span class="op">=</span> <span class="st">'discontinuous'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_cont</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">k</span>, y <span class="op">=</span> <span class="va">score_cont</span>, color <span class="op">=</span> <span class="st">'continuous'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"discontinuous"</span> <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                                <span class="st">"continuous"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">''</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="AdaptiveBW_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>By checking the table above, we could decide to select the 10th
nearest neighbour because it clearly corresponds to the major elbow in
the above figure. Also, the 21th neighbour gives the highest score.</p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-abramson1982bandwidth" class="csl-entry">
Abramson, Ian S. 1982. <span>“On Bandwidth Variation in Kernel
Estimates-a Square Root Law.”</span> <em>The Annals of Statistics</em>,
1217–23.
</div>
<div id="ref-loftsgaarden_nonparametric_1965" class="csl-entry">
Loftsgaarden, D. O., and C. P. Quesenberry. 1965. <span>“A
<span>Nonparametric</span> <span>Estimate</span> of a
<span>Multivariate</span> <span>Density</span>
<span>Function</span>.”</span> <em>The Annals of Mathematical
Statistics</em> 36 (3): 1049–51. <a href="https://doi.org/10.1214/aoms/1177700079" class="external-link">https://doi.org/10.1214/aoms/1177700079</a>.
</div>
<div id="ref-orava_k-nearest_2011" class="csl-entry">
Orava, Jan. 2011. <span>“K-Nearest Neighbour Kernel Density Estimation,
the Choice of Optimal k.”</span> <em>Tatra Mountains Mathematical
Publications</em> 50 (1): 39–50. <a href="https://doi.org/10.2478/v10127-011-0035-z" class="external-link">https://doi.org/10.2478/v10127-011-0035-z</a>.
</div>
<div id="ref-terrell_variable_1992" class="csl-entry">
Terrell, George R., and David W. Scott. 1992. <span>“Variable
<span>Kernel</span> <span>Density</span>
<span>Estimation</span>.”</span> <em>The Annals of Statistics</em> 20
(3): 1236–65. <a href="https://www.jstor.org/stable/2242011" class="external-link">https://www.jstor.org/stable/2242011</a>.
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jeremy Gelb.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
