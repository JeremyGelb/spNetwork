<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial Weight Matrices • spNetwork</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spatial Weight Matrices">
<meta property="og:description" content="spNetwork">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">spNetwork</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Isochrones.html">Calculating isochrones</a>
    </li>
    <li>
      <a href="../articles/KNetworkFunctions.html">Network k Functions</a>
    </li>
    <li>
      <a href="../articles/NetworkBuilding.html">Building graphs</a>
    </li>
    <li>
      <a href="../articles/NKDE.html">Network Kernel Density Estimate</a>
    </li>
    <li>
      <a href="../articles/SpatialWeightMatrices.html">Spatial Weight Matrices</a>
    </li>
    <li>
      <a href="../articles/TNKDE.html">Temporal Network Kernel Density Estimate</a>
    </li>
    <li>
      <a href="../articles/web_vignettes/AdaptiveBW.html">K-nearest neighbour adaptive bandwidth</a>
    </li>
    <li>
      <a href="../articles/web_vignettes/NKDEdetailed.html">Details about NKDE</a>
    </li>
    <li>
      <a href="../articles/web_vignettes/SpaceTimeDBscan.html">Spatio-temporal dbscan with network distance</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JeremyGelb/spNetwork/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spatial Weight Matrices</h1>
                        <h4 data-toc-skip class="author">Jeremy
Gelb</h4>
            
            <h4 data-toc-skip class="date">2023-10-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JeremyGelb/spNetwork/blob/HEAD/vignettes/SpatialWeightMatrices.Rmd" class="external-link"><code>vignettes/SpatialWeightMatrices.Rmd</code></a></small>
      <div class="hidden name"><code>SpatialWeightMatrices.Rmd</code></div>

    </div>

    
    
<p>This vignette is a short introduction to the spatial weight matrices
feature of the <strong>spNetwork</strong> package.</p>
<div class="section level2">
<h2 id="quick-introduction-to-spatial-weight-matrices">Quick introduction to spatial weight matrices<a class="anchor" aria-label="anchor" href="#quick-introduction-to-spatial-weight-matrices"></a>
</h2>
<p>A vast number of spatial analysis methods are based on a spatial
matrix W<sub>ij</sub> of size <em>n</em> x <em>n</em> with <em>i</em> an
observation and <em>j</em> the neighbours of that observation.
W<sub>ij</sub> represents the degree of spatial relationship between
<em>i</em> and <em>j</em>.</p>
<p>Classically one can define :</p>
<ul>
<li>neighbouring matrix (W<sub>ij</sub> = 1 if <em>j</em> is a neighbour
of <em>i</em>, 0 otherwise)</li>
<li>distance matrix (W<sub>ij</sub> = the distance between <em>i</em>
and <em>j</em>, modified by a function like <span class="math inline">\(\frac{1}{distance}\)</span> or <span class="math inline">\(\frac{1}{distance^2}\)</span>)</li>
<li>interaction matrix (W<sub>ij</sub> = the degree of interaction
between <em>i</em> and <em>j</em>, the measure of the interaction
depends on the subject of the analysis)</li>
</ul>
<p>In R, the classical package to deal with such matrices is the package
‘spdep’ which defines objects like neighbour lists and spatial weight
lists, and offers the possibility to convert these objects into regular
matrices.</p>
<p>When one works with data constrained on a network, using Euclidean
distance to estimate proximity between observations leads to an
underestimation of the real distances between them</p>
<p><strong>spNetwork</strong> makes it possible to create
<code>listw</code> objects based on network distance. Let us give an
example here: calculating the Moran autocorrelation index for the number
of bike accidents recorded on the Montreal road network in 2016.</p>
<p>First, we want to load data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"rgdal_show_exportToProj4_warnings"</span><span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jeremygelb.github.io/spNetwork/" class="external-link">spNetwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mtl_network</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span></span></code></pre></div>
<p>then we want to split lines into lixels and calculate for each lixel
the number of events on that lixel.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lixelize_lines.html">lixelize_lines</a></span><span class="op">(</span><span class="va">mtl_network</span>,<span class="fl">200</span>,mindist <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># defining and oid for the lixels</span></span>
<span><span class="va">lixels</span><span class="op">$</span><span class="va">oid</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lixels</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># snapping the points on the lines and counting</span></span>
<span><span class="va">snapped_acc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snapPointsToLines2.html">snapPointsToLines2</a></span><span class="op">(</span><span class="va">bike_accidents</span>,<span class="va">lixels</span>, idField <span class="op">=</span><span class="st">"oid"</span><span class="op">)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">snapped_acc</span><span class="op">$</span><span class="va">nearest_line_id</span><span class="op">)</span></span>
<span><span class="va">counts_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"oid"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        <span class="st">"count"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># merging the results</span></span>
<span><span class="va">lixels</span><span class="op">$</span><span class="va">nbAccident</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">lixels</span>,<span class="va">counts_df</span>, by<span class="op">=</span><span class="st">"oid"</span><span class="op">)</span><span class="op">$</span><span class="va">count</span></span>
<span><span class="va">nbAccident</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lixels</span><span class="op">$</span><span class="va">nbAccident</span><span class="op">)</span>,<span class="fl">0</span>,<span class="va">lixels</span><span class="op">$</span><span class="va">nbAccident</span><span class="op">)</span></span></code></pre></div>
<p>We use here the function <em>network_listw</em> the create a
<code>listw</code> object representing the spatial weight matrix. The
distances can be calculated from the centroids of the lixels, from the
extremities of the lixels or from evenly spaced points on the lixels. We
use here the second approach and specify it with the parameter
<code>method = "ends"</code>.</p>
<p>Let us consider that above 300 metres two segments are not neighbours
anymore, and convert the distances between the observations into spatial
weights by using the inverse of the squared distance.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">netlistw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/network_listw.html">network_listw</a></span><span class="op">(</span><span class="va">lixels</span>,<span class="va">mtl_network</span>,</span>
<span>                           method <span class="op">=</span> <span class="st">"ends"</span>,</span>
<span>                           mindist <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                           maxdistance <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                           dist_func <span class="op">=</span> <span class="st">"squared inverse"</span>,</span>
<span>                           line_weight <span class="op">=</span> <span class="st">'length'</span>,</span>
<span>                           matrice_type <span class="op">=</span> <span class="st">'W'</span>,</span>
<span>                           grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                           verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>With that matrix, we can calculate the Moran I for the number of
accidents on a lixel.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html" class="external-link">moran.test</a></span><span class="op">(</span><span class="va">nbAccident</span>, <span class="va">netlistw</span>, zero.policy <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Test</span><span class="op">$</span><span class="va">estimate</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Moran I statistic       Expectation          Variance </span></span>
<span><span class="co">#&gt;            0.0511           -0.0003            0.0001</span></span></code></pre></div>
<p>The autocorrelation is weak, this is due to the large distance used
and the fact that the analyzed variable is a counting variable (number
of accidents). Indeed, the Moran I is supposed to be used on continuous
variables.</p>
<p>One could go further and define its own function to convert distances
into spatial weights</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_conv_func</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">x</span><span class="op">&gt;=</span><span class="fl">300</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">x</span><span class="op">**</span><span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">netlistw2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/network_listw.html">network_listw</a></span><span class="op">(</span><span class="va">lixels</span>,<span class="va">mtl_network</span>,</span>
<span>                             method <span class="op">=</span> <span class="st">"ends"</span>,</span>
<span>                             mindist <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                             maxdistance <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                             dist_func <span class="op">=</span> <span class="va">my_conv_func</span>,</span>
<span>                             line_weight <span class="op">=</span> <span class="st">'length'</span>,</span>
<span>                             matrice_type <span class="op">=</span> <span class="st">'W'</span>,</span>
<span>                             grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                             verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>To speed up calculation, one could use a multiprocessing plan defined
with the package ‘future’. To do so, the study area is divided into
rectangles (according to the parameter <em>grid_shape</em>), and each
rectangle is treated separately. A buffer is applied around the
rectangles to avoid edge effects.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setting the multiprocess plan</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/multisession.html" class="external-link">multisession</a></span><span class="op">(</span>workers<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">netlistw3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/network_listw.mc.html">network_listw.mc</a></span><span class="op">(</span><span class="va">lixels</span>,<span class="va">lixels</span>,</span>
<span>                             method <span class="op">=</span> <span class="st">"ends"</span>,</span>
<span>                             mindist <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                             maxdistance <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                             dist_func <span class="op">=</span> <span class="va">my_conv_func</span>,</span>
<span>                             line_weight <span class="op">=</span> <span class="st">'length'</span>,</span>
<span>                             matrice_type <span class="op">=</span> <span class="st">'W'</span>,</span>
<span>                             grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                             verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"sequential"</span><span class="op">)</span><span class="op">)</span> <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="other-features">Other features<a class="anchor" aria-label="anchor" href="#other-features"></a>
</h2>
<ul>
<li>A spatial matrix could be calculated for every type of geometries
not only lines. Points can directly be used. For polygons, it is
possible to use the centres of the geometries as starting points. One
can also choose a distance and equally spaced starting points will be
defined on the border of the polygons according to that distance.</li>
<li>The cost of travelling on an edge could be set to something else
than “length”.</li>
<li>It is possible to specify directions on the network.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jeremy Gelb.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
