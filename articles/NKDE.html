<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Kernel Density Estimate • spNetwork</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Network Kernel Density Estimate">
<meta property="og:description" content="spNetwork">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">spNetwork</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Isochrones.html">Calculating isochrones</a>
    </li>
    <li>
      <a href="../articles/KNetworkFunctions.html">Network k Functions</a>
    </li>
    <li>
      <a href="../articles/NKDE.html">Network Kernel Density Estimate</a>
    </li>
    <li>
      <a href="../articles/NKDEdetailed.html">Details about NKDE</a>
    </li>
    <li>
      <a href="../articles/NetworkBuilding.html">Building graphs</a>
    </li>
    <li>
      <a href="../articles/SpatialWeightMatrices.html">Spatial Weight Matrices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JeremyGelb/spNetwork/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="NKDE_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Network Kernel Density Estimate</h1>
                        <h4 class="author">Jeremy Gelb</h4>
            
            <h4 class="date">2021-10-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JeremyGelb/spNetwork/blob/master/vignettes/NKDE.Rmd"><code>vignettes/NKDE.Rmd</code></a></small>
      <div class="hidden name"><code>NKDE.Rmd</code></div>

    </div>

    
    
<div id="quick-introduction-to-nkde" class="section level1">
<h1 class="hasAnchor">
<a href="#quick-introduction-to-nkde" class="anchor"></a>Quick introduction to NKDE</h1>
<p>A classical Kernel Density Estimate (KDE) estimates the continuous density of a set of events in a two-dimensional space. The density is estimated at sampling points, traditionally the centres of pixels dividing the study area into equal zones.</p>
<p>This approach is not adapted to analyze density of events occurring on a network, like accidents and crimes in streets, or leaks on a network of water pipes. Indeed, calculating density values for locations outside the network is meaningless and the Euclidean distance underestimates the real distance between two objects on the network. Moreover, networks are not isotropic spaces. In other words, it is not possible to move in every direction, but only along the edges of the network.</p>
<p>To calculate a Network Kernel Density Estimate (NKDE), it is possible to:</p>
<ul>
<li>use lixels instead of pixels. A lixel is a linear equivalent of a pixel on a network. The lines of the network are split into lixels according to a chosen resolution. The centres of the lixels are sampling points for which the density will be estimated.</li>
<li>calculate network distances between objects instead of Euclidean distances.</li>
<li>adjust the kernel function to deal with the anisotropic space</li>
</ul>
<p>A picture is worth a thousand of words, so let us consider this situation:</p>
<center>
<img src="images/step0.png" title="fig:" width="300" alt="Image Title">
</center>
<p>Each red point is an event and the lines constitute the network. One could calculate a simple KDE on that dataset and would obtain something like this:</p>
<center>
<img src="images/example_pixels.png" title="fig:" width="300" alt="Image Title">
</center>
<p>But this is only partially satisfying if we are interested in the density of the events on the network.</p>
<p>To perform a NKDE, the events must be snapped on the network. The snapped events are shown here in green.</p>
<center>
<img src="images/step1.png" title="fig:" width="300" alt="Image Title">
</center>
<p>The mass of each event can be seen as a third dimension and is evaluated by a selected kernel function (<em>K</em>) within a specified bandwidth. The kernel function must satisfy the following conditions:</p>
<p><span class="math inline">\(K(x) &gt;= 0 \text{, if } x &lt; bandwidth\)</span></p>
<p><span class="math inline">\(K(x) = 0 \text{, if } x &gt; bandwidth\)</span></p>
<p><span class="math inline">\(\int K(x)= 1\)</span></p>
<p>The total mass of an event is 1, and is spread according to the function <em>K</em> within the bandwidth.</p>
<p>For an easier representation, let us consider here the triangle kernel function.</p>
<center>
<img src="images/step2.png" title="fig:" width="300" alt="Image Title">
</center>
<p>We can see that the “influence” of each point is limited within the bandwidth and decreases when we move away from the event.</p>
<p>With this method, one can evaluate the density of the studied phenomenon at each location on the network. In the next figure, 3 sampling points (s1, s2 and s3) are added in blue.</p>
<center>
<img src="images/step3.png" title="fig:" width="300" alt="Image Title">
</center>
<p><span class="math display">\[d_{s1} = \frac{1}{bw^2}K(dist_{s1;e1})\]</span> <span class="math display">\[d_{s2} = \frac{1}{bw^2}K(dist_{s2;e2})\]</span> <span class="math display">\[d_{s3} = \frac{1}{bw^2}(K(dist_{s3;e2}) + K(dist_{s3;e3}))\]</span></p>
<p>And in a more general fashion: <span class="math inline">\(d_{si} = \frac{1}{bw^2} \sum_{j=1}^{n} K(dist_{si;ej})\)</span> with <span class="math inline">\(d_{si}\)</span> the density estimated at the sample point <em>si</em>, <em>bw</em> the bandwidth and <em>ej</em> an event.</p>
<p>The proposed kernel functions in the <strong>spNetwork</strong> package are:</p>
<ul>
<li><p>gaussian kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})=\dfrac{1}{\sqrt{2\pi}} * \exp(-\dfrac{d_{il}^2}{2r^2})\)</span></p></li>
<li><p>quartic kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})=\dfrac{3}{\pi} * (1-\dfrac{d_{il}^2}{r^2})\)</span></p></li>
<li><p>epanechnikov kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})=\dfrac{3}{4}*(1-\dfrac{d_{il}^2}{r^2})\)</span></p></li>
<li><p>triangle kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})= 1 - |\dfrac{d_{il}}{r}|\)</span></p></li>
<li><p>uniform kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})= |\dfrac{1}{r}|\)</span></p></li>
<li><p>triweight kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})= \dfrac{35}{32} * (1-\dfrac{d_{il}}{r}^2)^3\)</span></p></li>
<li><p>tricube kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})= \dfrac{70}{81} * (1-|\dfrac{d_{il}}{r}|^3)^3\)</span></p></li>
<li><p>cosine kernel: <span class="math inline">\(k(\dfrac{d_{il}}{r})= \dfrac{\pi}{4} * (cos(\dfrac{\pi}{2}*\dfrac{d_{il}}{r}))\)</span></p></li>
</ul>
<p>with <em>r</em> the bandwidth, and <span class="math inline">\(d_{il}\)</span> the distance between an event and the sampling point.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape">reshape2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jeremygelb.github.io/spNetwork/">spNetwork</a></span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">15.01</span>,<span class="fl">15.01</span>,by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">x</span>,
  gaussian <span class="op">=</span> <span class="fu"><a href="../reference/gaussian_kernel.html">gaussian_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  epanechnikov <span class="op">=</span> <span class="fu"><a href="../reference/epanechnikov_kernel.html">epanechnikov_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  quartic <span class="op">=</span> <span class="fu"><a href="../reference/quartic_kernel.html">quartic_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  triangle <span class="op">=</span> <span class="fu"><a href="../reference/triangle_kernel.html">triangle_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  tricube <span class="op">=</span> <span class="fu"><a href="../reference/tricube_kernel.html">tricube_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  triweight <span class="op">=</span> <span class="fu"><a href="../reference/triweight_kernel.html">triweight_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  cosine <span class="op">=</span> <span class="fu"><a href="../reference/cosine_kernel.html">cosine_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  uniform <span class="op">=</span> <span class="fu"><a href="../reference/uniform_kernel.html">uniform_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span><span class="op">)</span>

<span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span><span class="va">df</span>, id.vars <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"kernel"</span>,<span class="st">"y"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span>,color<span class="op">=</span><span class="va">kernel</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="NKDE_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>As one can see, most of the kernels look alike. It is worth mentioning that the gaussian kernel does not integrate to 1 within the bandwidth (specific case of non-compact kernel). In the <strong>spNetwork</strong> package, all kernel values beyond the bandwidth are set to 0. This means that some mass of each event is lost with the gaussian kernel. To limit this effect, one can use the scaled version of the gaussian kernel for which the bandwidth is divided by 3, limiting greatly the mass loss.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Funs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">gaussian_kernel</span>, <span class="va">gaussian_kernel_scaled</span>,<span class="va">epanechnikov_kernel</span>,
          <span class="va">quartic_kernel</span>,<span class="va">triangle_kernel</span>, <span class="va">uniform_kernel</span>,
          <span class="va">tricube_kernel</span>,<span class="va">triweight_kernel</span>,
          <span class="va">cosine_kernel</span><span class="op">)</span>
<span class="va">Names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gaussian"</span>, <span class="st">"scaled gaussian"</span>, <span class="st">"epanechnikov"</span>, <span class="st">"quartic"</span>,
           <span class="st">"triangle"</span>,<span class="st">"uniform"</span>, <span class="st">"tricube"</span>, <span class="st">"triweight"</span>, <span class="st">"cosine"</span><span class="op">)</span>
<span class="va">integrals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">Funs</span>,<span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/integrate.html">integrate</a></span><span class="op">(</span><span class="va">f</span>,upper<span class="op">=</span><span class="fl">15</span>,lower<span class="op">=</span><span class="op">-</span><span class="fl">15</span>,bw<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">$</span><span class="va">value</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
         <span class="op">}</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">"kernel"</span><span class="op">=</span><span class="va">Names</span>,
                 <span class="st">"integrals"</span> <span class="op">=</span> <span class="va">integrals</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr>
<th style="text-align:left;">
kernel
</th>
<th style="text-align:right;">
integrals
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
gaussian
</td>
<td style="text-align:right;">
0.683
</td>
</tr>
<tr>
<td style="text-align:left;">
scaled gaussian
</td>
<td style="text-align:right;">
0.997
</td>
</tr>
<tr>
<td style="text-align:left;">
epanechnikov
</td>
<td style="text-align:right;">
1.000
</td>
</tr>
<tr>
<td style="text-align:left;">
quartic
</td>
<td style="text-align:right;">
1.000
</td>
</tr>
<tr>
<td style="text-align:left;">
triangle
</td>
<td style="text-align:right;">
1.000
</td>
</tr>
<tr>
<td style="text-align:left;">
uniform
</td>
<td style="text-align:right;">
1.000
</td>
</tr>
<tr>
<td style="text-align:left;">
tricube
</td>
<td style="text-align:right;">
1.000
</td>
</tr>
<tr>
<td style="text-align:left;">
triweight
</td>
<td style="text-align:right;">
1.000
</td>
</tr>
<tr>
<td style="text-align:left;">
cosine
</td>
<td style="text-align:right;">
1.000
</td>
</tr>
</tbody>
</table>
<p>However, the fact that the gaussian kernel does not integrate to 1 within the bandwidth can leads to negative values when using the continuous NKDE (presented latter). Thus, we recommend using the quartic kernel instead.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">15.01</span>,<span class="fl">15.01</span>,by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">x</span>,
  gaussian <span class="op">=</span> <span class="fu"><a href="../reference/gaussian_kernel.html">gaussian_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  gaussian_scaled <span class="op">=</span> <span class="fu"><a href="../reference/gaussian_kernel_scaled.html">gaussian_kernel_scaled</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  epanechnikov <span class="op">=</span> <span class="fu"><a href="../reference/epanechnikov_kernel.html">epanechnikov_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>,
  quartic <span class="op">=</span> <span class="fu"><a href="../reference/quartic_kernel.html">quartic_kernel</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">15</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span><span class="va">df</span>, id.vars <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"kernel"</span>,<span class="st">"y"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span>,color<span class="op">=</span><span class="va">kernel</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="NKDE_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div id="the-three-versions-of-nkde" class="section level1">
<h1 class="hasAnchor">
<a href="#the-three-versions-of-nkde" class="anchor"></a>The three versions of NKDE</h1>
<p>The <strong>spNetwork</strong> package provides three methods to calculate NKDE. We present them briefly here. For more details, please read the original papers and books cited. An other vignette is also available (<em>Details about NKDE</em>) to explore the three of them in 3D plots.</p>
<div id="simple-method" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-method" class="anchor"></a>Simple method</h2>
<p>The first method was proposed by <span class="citation">Xie and Yan (<a href="#ref-xie2008kernel" role="doc-biblioref">2008</a>)</span>. Considering the planar KDE, they defined the NKDE with the following formula:</p>
<p><span class="math inline">\(d_{si} = \frac{1}{bw}\sum_{j=1}^{n} K(dist_{si;ej})\)</span></p>
<p>with <span class="math inline">\(d_{si}\)</span> the density estimated at sample the point <em>si</em>, <span class="math inline">\(dist_{si;ej}\)</span> the network distance between <em>si</em> and event <em>j</em>, with all distances <span class="math inline">\(dist_{si;ej} &lt; bw\)</span>.</p>
<p>Of course, it uses the network distance instead of the Euclidean distance. This method is appealing because it is intuitive, but it is not statistically satisfying. Note that the divisor of the kernel is not the classical <span class="math inline">\(\frac{1}{bw^2}\)</span>, but <span class="math inline">\(\frac{1}{bw}\)</span>. This adjustment allows for a simpler interpretation of the density: <em>“Instead of calculating the density over an area unit, the equation estimates the density over a linear unit”</em> <span class="citation">(Xie and Yan <a href="#ref-xie2008kernel" role="doc-biblioref">2008</a>, 398)</span></p>
<p>In the next figure, we show in 3D what that kernel looks like. The red point is a simple event, the black lines are the network, and the blue lines are the calculated densities.</p>
<center>
<img src="images/simple_nkde_ex.png" title="fig:" width="150" alt="Image Title">
</center>
<p>As one can see, this NKDE is only determined by the distance between the sampling points and the event. This is a problem because at intersections, the event’s mass is multiplied by the number of edges at that intersection. Consequently, this is not a true kernel because it does not integrate to 1 on its domain.</p>
<p>This method remains useful for two reasons:</p>
<ul>
<li>For quick data visualization. With big datasets, it might be useful to use this simple method to do a primary investigation.</li>
<li>In a purely geographical view, this method is intuitive. In the case of crime analysis for example, one could argue that the <em>strength</em> of an event should not be affected by intersections on the network. In that case, the kernel function is seen as a distance decaying function.</li>
</ul>
<p><strong>What to retain about the simple method ?</strong></p>
<table class="table">
<thead><tr class="header">
<th align="center">Pros</th>
<th align="center">Cons</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">quick to calculate</td>
<td align="center">biased (not a true kernel)</td>
</tr>
<tr class="even">
<td align="center">intuitive</td>
<td align="center">overestimate the densities</td>
</tr>
<tr class="odd">
<td align="center">continuous</td>
<td align="center"></td>
</tr>
</tbody>
</table>
</div>
<div id="discontinuous-nkde" class="section level2">
<h2 class="hasAnchor">
<a href="#discontinuous-nkde" class="anchor"></a>Discontinuous NKDE</h2>
<p><span class="citation">Okabe and Sugihara (<a href="#ref-okabe2012spatial" role="doc-biblioref">2012</a>)</span> have criticized the previous method, arguing that the produced density estimator is biased, conducting to overestimation of density. To overcome this limit, they presented two heuristic techniques: the discontinuous and the continuous NKDE.</p>
<p>The discontinuous NKDE is easily presented by a figure:</p>
<center>
<img src="images/discontinuous.png" title="fig:" width="300" alt="Image Title">
</center>
<p>The density of the kernel function is equally divided at intersections. Note that <strong>spNetwork</strong> implements the modified version proposed by <span class="citation">Sugihara, Satoh, and Okabe (<a href="#ref-sugihara2010simple" role="doc-biblioref">2010</a>)</span>, allowing for use in networks with cycles. In the case of a cycle, the multiple overlapping values of the kernel are added, as shown in the next figure.</p>
<center>
<img src="images/cycle_nkde.png" title="fig:" width="300" alt="Image Title">
</center>
<p>With the case presented before, we obtain the following result.</p>
<center>
<img src="images/discontinuous_nkde_ex.png" title="fig:" width="150" alt="Image Title">
</center>
<p>As one can see, the values of the NKDE are split at intersections to avoid the multiplication of the mass observed in the simple version. However, this creates a discontinuous NKDE, which is counter-intuitive. It leads to sharp differences between density values in the network, and could be problematic in networks with many intersections.</p>
<p><strong>What to retain about the discontinuous method ?</strong></p>
<table class="table">
<thead><tr class="header">
<th align="center">Pros</th>
<th align="center">Cons</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">quick to calculate</td>
<td align="center">counter-intuitive</td>
</tr>
<tr class="even">
<td align="center">unbiased</td>
<td align="center">discontinuous</td>
</tr>
<tr class="odd">
<td align="center"></td>
<td align="center">contrasted results</td>
</tr>
</tbody>
</table>
</div>
<div id="continuous-nkde" class="section level2">
<h2 class="hasAnchor">
<a href="#continuous-nkde" class="anchor"></a>Continuous NKDE</h2>
<p>If the previous method is an unbiased estimator and quite easy to calculate, its discontinuous nature might be counter-intuitive in comparison with the simple method. The continuous NKDE merges the best of the two worlds: it adjusts the values of the NKDE at intersections to ensure that it integrates to 1 on its domain, and applies a backward correction to force the density values to be continuous. This process is accomplished by a recursive function, described in the book <em>Spatial Analysis Along Networks</em> <span class="citation">(Okabe and Sugihara <a href="#ref-okabe2012spatial" role="doc-biblioref">2012</a>)</span>. This function is more time consuming, so it might be necessary to stop it when the recursion is too deep. Considering that the kernel density is divided at each intersection, stopping the function at deep level 16 should give results almost identical to the true values.</p>
<center>
<img src="images/continuous.png" title="fig:" width="300" alt="Image Title">
</center>
<p>There are three different equations to calculate the kernel density depending on the situation (here, q1, q2, q3).</p>
<p>Again, with the case presented before, we obtain the following result.</p>
<center>
<img src="images/continuous_nkde_ex.png" title="fig:" width="150" alt="Image Title">
</center>
<p>As one can see, the values of the NKDE are continuous, and the density values close to the events have been adjusted. This leads to smoother results than the discontinuous method.</p>
<p><strong>What to retain about the discontinuous method</strong></p>
<table class="table">
<thead><tr class="header">
<th align="center">Pros</th>
<th align="center">Cons</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">unbiased</td>
<td align="center">long calculation time</td>
</tr>
<tr class="even">
<td align="center">continuous</td>
<td align="center">smoother values</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="nkde-in-spnetwork" class="section level1">
<h1 class="hasAnchor">
<a href="#nkde-in-spnetwork" class="anchor"></a>NKDE in spNetwork</h1>
<p>The <strong>spNetwork</strong> package makes this type of analysis straightforward in R. The main problem of the implementation of the NKDE is to reduce computation time. Indeed, for a large dataset, building the network and evaluating the distances between each event and each sampling point would be too long and could lead to memory issues.</p>
<p>To avoid this, the first solution provided in <strong>spNetwork</strong> is a gridded application of the NKDE. The user can split the study area with a grid, the calculation is then performed in each cell of the grid. A buffer is applied on each cell to avoid frontier effect. This behaviour is controlled by the parameter <code>grid_shape</code>, indicating the shape of the grid. To split the study area in four rectangles, one can use <code>grid_shape = c(2,2)</code>. For a reasonable dataset, it is also possible not to split the study area with <code>grid_shape = c(1,1)</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># first load data and packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://maptools.r-forge.r-project.org/">maptools</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/rgeos/">rgeos</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jeremygelb.github.io/spNetwork/">spNetwork</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>

<span class="va">networkgpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"networks.gpkg"</span>,
                           package <span class="op">=</span> <span class="st">"spNetwork"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">eventsgpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"events.gpkg"</span>,
                          package <span class="op">=</span> <span class="st">"spNetwork"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">mtl_network</span> <span class="op">&lt;-</span> <span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readOGR.html">readOGR</a></span><span class="op">(</span><span class="va">networkgpkg</span>,layer<span class="op">=</span><span class="st">"mtl_network"</span>,verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">bike_accidents</span> <span class="op">&lt;-</span> <span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readOGR.html">readOGR</a></span><span class="op">(</span><span class="va">eventsgpkg</span>,layer<span class="op">=</span><span class="st">"bike_accidents"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># then plotting the data</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">mtl_network</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">bike_accidents</span>,add<span class="op">=</span><span class="cn">T</span>,col<span class="op">=</span><span class="st">'red'</span>,pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></code></pre></div>
<p><img src="NKDE_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># then calculating some lixels to use as sampling points</span>
<span class="va">lixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lixelize_lines.html">lixelize_lines</a></span><span class="op">(</span><span class="va">mtl_network</span>,<span class="fl">200</span>,mindist <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lines_center.html">lines_center</a></span><span class="op">(</span><span class="va">lixels</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># then applying the NKDE</span>
<span class="va">densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nkde.html">nkde</a></span><span class="op">(</span><span class="va">mtl_network</span>, 
                  events <span class="op">=</span> <span class="va">bike_accidents</span>,
                  w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,
                  samples <span class="op">=</span> <span class="va">samples</span>,
                  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>,
                  bw <span class="op">=</span> <span class="fl">300</span>, div<span class="op">=</span> <span class="st">"bw"</span>, 
                  method <span class="op">=</span> <span class="st">"discontinuous"</span>, digits <span class="op">=</span> <span class="fl">1</span>, tol <span class="op">=</span> <span class="fl">1</span>,
                  grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, max_depth <span class="op">=</span> <span class="fl">8</span>,
                  agg <span class="op">=</span> <span class="fl">5</span>, <span class="co">#we aggregate events within a 5m radius (faster calculation)</span>
                  sparse <span class="op">=</span> <span class="cn">TRUE</span>,
                  verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">densities</span></code></pre></div>
<p>We can now map the density values estimated for each lixel centre:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/classInt/">classInt</a></span><span class="op">)</span>

<span class="co"># rescaling to help the mapping</span>
<span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">$</span><span class="va">density</span><span class="op">*</span><span class="fl">1000</span>

<span class="co"># using a discretization method</span>
<span class="va">breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/classInt/reference/classIntervals.html">classIntervals</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">density</span>, n <span class="op">=</span> <span class="fl">7</span>, style <span class="op">=</span> <span class="st">"jenks"</span>, intervalClosure <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>

<span class="va">colorRamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">7</span>, name <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span>
<span class="va">colorRamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="va">colorRamp</span><span class="op">)</span>

<span class="va">samples</span><span class="op">$</span><span class="va">class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/cut.html">cut</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">density</span>,<span class="va">breaks</span><span class="op">$</span><span class="va">brks</span>,<span class="va">colorRamp</span>,include.lowest <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html">coordinates</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="va">samples</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">xy</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">samples</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">xy</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>

<span class="co"># and finally map with ggplot</span>
<span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">breaks</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; style: jenks</span>
<span class="co">#&gt;          [0,0.001662401] (0.001662401,0.00435006] (0.00435006,0.007797132] </span>
<span class="co">#&gt;                     1554                      656                      462 </span>
<span class="co">#&gt; (0.007797132,0.01237768]  (0.01237768,0.01880149]  (0.01880149,0.02859259] </span>
<span class="co">#&gt;                      269                      145                       57 </span>
<span class="co">#&gt;  (0.02859259,0.04626886] </span>
<span class="co">#&gt;                       19</span>
<span class="va">mtl_network</span><span class="op">$</span><span class="va">line_id</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">mtl_network</span><span class="op">)</span>
<span class="va">Mapnetwork</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span><span class="va">mtl_network</span>,id<span class="op">=</span><span class="st">"line_id"</span><span class="op">)</span>

<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">samples</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">density</span><span class="op">)</span>,<span class="op">]</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">Mapnetwork</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">long</span>,y<span class="op">=</span><span class="va">lat</span>,group<span class="op">=</span><span class="va">group</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"black"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span>,color<span class="op">=</span><span class="va">class</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span><span class="st">"density"</span>,
    breaks <span class="op">=</span> <span class="va">colorRamp</span>, values <span class="op">=</span> <span class="va">colorRamp</span>, 
    label <span class="op">=</span> <span class="va">labels</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_fixed</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"bike accident density by kilometres in 2016"</span>,
          subtitle <span class="op">=</span> <span class="st">"within a radius of 300 metres"</span>,
          caption <span class="op">=</span> <span class="st">"using the quartic kernel"</span><span class="op">)</span></code></pre></div>
<p><img src="NKDE_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>As you can imagine it remains a costly process, especially for the continuous kernel. The package <strong>spNetwork</strong> uses three approaches simultaneously to reduce calculation time:</p>
<ul>
<li>‘Rcpp’: the main functions are coded with C++</li>
<li>‘Armadillo’: the linear algebra is performed with the ‘RcppArmadillo’ package</li>
<li>multiprocessing: it is possible to split the calculation on multiple cores</li>
</ul>
<p>The calculus of the NKDE for each cell could be done by several cores. To do so, <strong>spNetwork</strong> provides a function <code>nkde.mc</code>. More specifically, it uses functions from the packages <code>future</code> and <code>future.apply</code>. The selection of the plan has to be done by the user to ensure the best compatibility on each os and computer. See the documentation of the <code>future</code> package if needed.</p>
<p>The following code will produce the same results as before but split the work between two cores.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># setting the multisession plan</span>
<span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/multisession.html">multisession</a></span><span class="op">(</span>workers<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="co"># then applying the NKDE</span>
<span class="va">densities_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nkde.mc.html">nkde.mc</a></span><span class="op">(</span><span class="va">mtl_network</span>, 
                  events <span class="op">=</span> <span class="va">bike_accidents</span>,
                  w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,
                  samples <span class="op">=</span> <span class="va">samples</span>,
                  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>,
                  bw <span class="op">=</span> <span class="fl">300</span>, div<span class="op">=</span> <span class="st">"bw"</span>, 
                  method <span class="op">=</span> <span class="st">"discontinuous"</span>, digits <span class="op">=</span> <span class="fl">1</span>, tol <span class="op">=</span> <span class="fl">1</span>,
                  grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, <span class="co"># splitting the study area in 4 rectangles</span>
                  max_depth <span class="op">=</span> <span class="fl">8</span>,
                  agg <span class="op">=</span> <span class="fl">5</span>, <span class="co">#we aggregate events within a 5m radius</span>
                  sparse <span class="op">=</span> <span class="cn">TRUE</span>,
                  verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># let's set back the classical sequential plan</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"sequential"</span><span class="op">)</span><span class="op">)</span> <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html">sequential</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># we can compare the previous result and the new one</span>
<span class="va">diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">densities</span> <span class="op">-</span> <span class="va">densities_mc</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"overall difference between the regular and paralellized method : "</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">diff</span>,<span class="fl">12</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "overall difference between the regular and paralellized method : 0"</span></code></pre></div>
</div>
<div id="an-example-with-adaptive-bandwidth" class="section level1">
<h1 class="hasAnchor">
<a href="#an-example-with-adaptive-bandwidth" class="anchor"></a>An example with adaptive bandwidth</h1>
<p>The examples provided in the previous sections are using only a fixed bandwidth. If we relax the need for a fixed bandwidth, we obtain an adaptive estimator. In other words, the bandwidth may vary in the study area. <strong>spNetwork</strong> uses the method proposed by <span class="citation">Abramson (<a href="#ref-abramson1982bandwidth" role="doc-biblioref">1982</a>)</span>, implying a variation of the bandwidth that is inversely proportional to the square root of the target density itself. In other words, at places where the density of the spatial process is high, the bandwidth of the kernel will be smaller and inversely. The use of an adaptive bandwidth has many theoretical and practical advantages. First, it reduces the sensibility to outliers. Second, it reduces smoothing in sub-region with many events (giving more detailed density estimation) and increases the smoothing in sub-region with few events (giving fuzzier results because of the higher uncertainty).</p>
<p>The problem is that the true density itself is unknown (otherwise we would not have to estimate it with a smoothing method). To obtain the adaptive bandwidth, a three steps method is used :</p>
<ol style="list-style-type: decimal">
<li>A fixed reference bandwidth (<span class="math inline">\(h_{0}\)</span>) is selected. For each event (<span class="math inline">\(e_{i}\)</span>) on the network, the density of the spatial process is evaluated by using this reference bandwidth (<span class="math inline">\(\tilde{f}h_{0}(e_{i})\)</span>).</li>
<li>For each event, the adaptive bandwidth is calculated with the following formula. A trimming value can be defined to limit the maximum of the calculated adaptive bandwidths.</li>
<li>The densities at sampling points are then evaluated by using the obtained vector of bandwidth for each event.</li>
</ol>
<p><span class="math display">\[
h(e_{i}) = h_{0} * \frac{1}{\sqrt{\tilde{f}h_{0}(e_{i})}} * \frac{1}{\gamma_{f}}\\
\gamma_{f} = \exp(\frac{\sum_{i}log(\frac{1}{\sqrt{\tilde{f}h_{0}(e_{i})}})}{n})
\]</span></p>
<p>This method is called event oriented, because the new bandwidths are evaluated for the events rather than the sampling points. The sample oriented method is not implemented because not compatible with the internal structure of <strong>spNetwork</strong>. Moreover, the event oriented density has an interesting advantage: adding more sampling points to have a more detailed density estimation has only a little impact on calculation time.</p>
<p>In <strong>spNetwork</strong>, when an adaptive bandwidth is used, the calculated bandwidth for each event is returned too.</p>
<p>Let us calculate a new NKDE, but with an adaptive bandwidth.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">adapt_densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nkde.html">nkde</a></span><span class="op">(</span><span class="va">mtl_network</span>, 
                  events <span class="op">=</span> <span class="va">bike_accidents</span>,
                  w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,
                  samples <span class="op">=</span> <span class="va">samples</span>,
                  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>,
                  bw <span class="op">=</span> <span class="fl">300</span>, div<span class="op">=</span> <span class="st">"bw"</span>, 
                  adaptive <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># we use here an adaptive bandwidth</span>
                  trim_bw <span class="op">=</span> <span class="fl">600</span>, <span class="co"># the maximum local values of bandwidth will be 600m</span>
                  method <span class="op">=</span> <span class="st">"discontinuous"</span>, digits <span class="op">=</span> <span class="fl">1</span>, tol <span class="op">=</span> <span class="fl">1</span>,
                  grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, max_depth <span class="op">=</span> <span class="fl">16</span>,
                  agg <span class="op">=</span> <span class="fl">5</span>, <span class="co">#we aggregate events within a 5m radius (faster calculation)</span>
                  sparse <span class="op">=</span> <span class="cn">TRUE</span>,
                  verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>

<span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">adapt_densities</span><span class="op">$</span><span class="va">k</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">adapt_densities</span><span class="op">$</span><span class="va">k</span></code></pre></div>
<p>We can now map some of the bandwidths</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">circles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/misc-gBuffer.html">gBuffer</a></span><span class="op">(</span><span class="va">adapt_densities</span><span class="op">$</span><span class="va">events</span>,byid <span class="op">=</span> <span class="cn">TRUE</span>,width <span class="op">=</span> <span class="va">adapt_densities</span><span class="op">$</span><span class="va">events</span><span class="op">$</span><span class="va">bw</span><span class="op">)</span>

<span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">52</span>,<span class="fl">20</span>,<span class="fl">86</span>,<span class="fl">14</span>,<span class="fl">75</span>,<span class="fl">126</span>,<span class="fl">200</span>,<span class="fl">177</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">mtl_network</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">bike_accidents</span>,add<span class="op">=</span><span class="cn">T</span>,col<span class="op">=</span><span class="st">'red'</span>,pch <span class="op">=</span> <span class="fl">19</span>,cex<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">circles</span><span class="op">[</span><span class="va">ids</span>,<span class="op">]</span>,add<span class="op">=</span><span class="cn">T</span>,border<span class="op">=</span><span class="st">'blue'</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="NKDE_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>And map the new densities with the same code as before.</p>
<pre><code>#&gt; style: jenks
#&gt;           [0,0.002095183] (0.002095183,0.005201574]  (0.005201574,0.00924476] 
#&gt;                      1744                       737                       334 
#&gt;   (0.00924476,0.01517735]   (0.01517735,0.02449563]    (0.02449563,0.0398348] 
#&gt;                       189                       114                        30 
#&gt;    (0.0398348,0.07519629] 
#&gt;                        14</code></pre>
<p><img src="NKDE_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<div id="applying-a-correction-factor-to-avoid-edge-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#applying-a-correction-factor-to-avoid-edge-effects" class="anchor"></a>Applying a correction factor to avoid edge effects</h2>
<p>When the study area is bounded, the kernel density estimate is biased at the border because the events at the other side of the border are not sampled. To mitigate the induced bias, one could apply the Diggle correction factor.</p>
<p><span class="math display">\[d(u) = \sum_{i=1}^{n}\frac{1}{e(x_{i})}K(dist(u-x_{i}))\\e(u) = \int_{W}{K(dist(u,v))}\]</span> The correction factor <span class="math inline">\(e(u)\)</span> is calculated for each event for which a part of its mass is outside the study area. More precisely, <span class="math inline">\(e(x_{i})\)</span> is the percentage of the mass of the event <span class="math inline">\(x_i\)</span> located inside the study area. The kernel function could be the simple, the continuous or the discontinuous. This correction factor can be used with the adaptive bandwidth too. Note that this correction is usable only if the network outside the study_area is available.</p>
<p>Let us illustrate it here by using a sub part of the same data</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># selecting the events in a subset of the data</span>
<span class="va">center_event</span> <span class="op">&lt;-</span> <span class="va">bike_accidents</span><span class="op">[</span><span class="fl">125</span>,<span class="op">]</span>
<span class="va">study_area</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/misc-gBuffer.html">gBuffer</a></span><span class="op">(</span><span class="va">center_event</span>,width <span class="op">=</span> <span class="fl">800</span><span class="op">)</span>
<span class="va">events_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/pred-binary-gIntersects.html">gIntersects</a></span><span class="op">(</span><span class="va">bike_accidents</span>, <span class="va">study_area</span>,byid<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/subset.html">subset</a></span><span class="op">(</span><span class="va">bike_accidents</span>,<span class="va">events_sel</span><span class="op">)</span>

<span class="co"># generating the sampling points</span>
<span class="va">lines_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/pred-binary-gIntersects.html">gIntersects</a></span><span class="op">(</span><span class="va">mtl_network</span>, <span class="va">study_area</span>,byid<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/subset.html">subset</a></span><span class="op">(</span><span class="va">mtl_network</span>,<span class="va">lines_sel</span><span class="op">)</span>

<span class="va">lixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lixelize_lines.html">lixelize_lines</a></span><span class="op">(</span><span class="va">lines</span>,<span class="fl">200</span>,mindist <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lines_center.html">lines_center</a></span><span class="op">(</span><span class="va">lixels</span><span class="op">)</span>


<span class="fu">sp</span><span class="fu">::</span><span class="fu">plot</span><span class="op">(</span><span class="va">study_area</span>,col<span class="op">=</span><span class="st">"white"</span><span class="op">)</span>
<span class="fu">sp</span><span class="fu">::</span><span class="fu">plot</span><span class="op">(</span><span class="va">mtl_network</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">sp</span><span class="fu">::</span><span class="fu">plot</span><span class="op">(</span><span class="va">events</span>,add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></code></pre></div>
<p><img src="NKDE_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># calculating the NKDE values, adjusted</span>
<span class="va">adjusted_densities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nkde.html">nkde</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">mtl_network</span>,
                            events <span class="op">=</span> <span class="va">events</span>,
                            w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span><span class="op">)</span>,
                            samples <span class="op">=</span> <span class="va">samples</span>,
                            kernel_name <span class="op">=</span> <span class="st">"quartic"</span>,
                            bw <span class="op">=</span> <span class="fl">150</span>,
                            adaptive <span class="op">=</span> <span class="cn">FALSE</span>,
                            method <span class="op">=</span> <span class="st">"discontinuous"</span>,
                            div <span class="op">=</span> <span class="st">"bw"</span>,
                            diggle_correction <span class="op">=</span> <span class="cn">TRUE</span>, study_area <span class="op">=</span> <span class="va">study_area</span>,
                            max_depth <span class="op">=</span> <span class="fl">15</span>,
                            digits <span class="op">=</span> <span class="fl">2</span>,tol <span class="op">=</span> <span class="fl">0.1</span>,agg <span class="op">=</span> <span class="fl">5</span>,sparse <span class="op">=</span> <span class="cn">TRUE</span>,
                            grid_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">adjusted_densities</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples</span><span class="op">$</span><span class="va">density</span> <span class="op">&lt;-</span> <span class="va">adjusted_densities</span></code></pre></div>
<p>And again, we can map the results.</p>
<pre><code>#&gt; style: jenks
#&gt;          [0,0.005012002] (0.005012002,0.01542759]  (0.01542759,0.02911514] 
#&gt;                      296                       56                       53 
#&gt;   (0.02911514,0.0439638]   (0.0439638,0.06249475]  (0.06249475,0.08333333] 
#&gt;                       16                       17                        3 
#&gt;   (0.08333333,0.1515667] 
#&gt;                        3</code></pre>
<p><img src="NKDE_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
</div>
<div id="bandwidth-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#bandwidth-selection" class="anchor"></a>Bandwidth selection</h2>
<p>The bandwidth is the most important parameter when doing kernel density estimate. Many methods have been proposed to find an optimal bandwidth but all of them are either crude approximations or require large calculus time. In that context, selecting a theory based bandwidth is recommended. However, <strong>spNetwork</strong> provides currently two functions to do data driven bandwidth selection:</p>
<ul>
<li>
<code>bw_cv_likelihood_calc</code>, using likelihood cross validation by leave one out. The idea is to find a bandwidth that will produce the most similar results if an event is dropped.</li>
<li>
<code>bw_cvl_calc</code>, using the Cronie and Van Lieshout’s Criterion <span class="citation">(Cronie and Van Lieshout <a href="#ref-cronie2018non" role="doc-biblioref">2018</a>)</span>. The goal is to minimize the difference between the size of the observation window and the sum of the reciprocal of the estimated kernel density at the events locations. In the network case, the size of the study area is the sum of the length of each line in the network. Thus, it is important to only use the relevant parts of the network.</li>
</ul>
<p>For both, one can uses the multicore version of the functions to speed up the calculation. It is also possible to run it on a subset of the dataset (based on the spatial grid) if running time is too long.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bws_selection_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bw_cv_likelihood_calc.html">bw_cv_likelihood_calc</a></span><span class="op">(</span>
  bw_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">200</span>,<span class="fl">700</span><span class="op">)</span>,bw_step <span class="op">=</span> <span class="fl">50</span>,
  lines <span class="op">=</span> <span class="va">mtl_network</span>, events <span class="op">=</span> <span class="va">bike_accidents</span>,
  w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,
  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>, method <span class="op">=</span> <span class="st">"discontinuous"</span>,
  diggle_correction <span class="op">=</span> <span class="cn">FALSE</span>, study_area <span class="op">=</span> <span class="cn">NULL</span>,
  max_depth <span class="op">=</span> <span class="fl">8</span>,
  digits<span class="op">=</span><span class="fl">2</span>, tol<span class="op">=</span><span class="fl">0.1</span>, agg<span class="op">=</span><span class="fl">5</span>, 
  sparse<span class="op">=</span><span class="cn">TRUE</span>, grid_shape<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,
  verbose<span class="op">=</span><span class="cn">FALSE</span>, check<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">bws_selection_cvl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bw_cvl_calc.html">bw_cvl_calc</a></span><span class="op">(</span>
  bw_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">200</span>,<span class="fl">700</span><span class="op">)</span>,bw_step <span class="op">=</span> <span class="fl">50</span>,
  lines <span class="op">=</span> <span class="va">mtl_network</span>, events <span class="op">=</span> <span class="va">bike_accidents</span>,
  w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">bike_accidents</span><span class="op">)</span><span class="op">)</span>,
  kernel_name <span class="op">=</span> <span class="st">"quartic"</span>, method <span class="op">=</span> <span class="st">"discontinuous"</span>,
  diggle_correction <span class="op">=</span> <span class="cn">FALSE</span>, study_area <span class="op">=</span> <span class="cn">NULL</span>,
  max_depth <span class="op">=</span> <span class="fl">8</span>,
  digits<span class="op">=</span><span class="fl">2</span>, tol<span class="op">=</span><span class="fl">0.1</span>, agg<span class="op">=</span><span class="fl">5</span>, 
  sparse<span class="op">=</span><span class="cn">TRUE</span>, grid_shape<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,
  verbose<span class="op">=</span><span class="cn">FALSE</span>, check<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">cv_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  <span class="st">"bw"</span> <span class="op">=</span> <span class="va">bws_selection_cv</span><span class="op">$</span><span class="va">bw</span>,
  <span class="st">"cv_likelihood"</span> <span class="op">=</span> <span class="va">bws_selection_cv</span><span class="op">$</span><span class="va">cv_scores</span>,
  <span class="st">"cvl_crit"</span> <span class="op">=</span> <span class="va">bws_selection_cvl</span><span class="op">$</span><span class="va">cvl_scores</span>
<span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr>
<th style="text-align:right;">
bw
</th>
<th style="text-align:right;">
cv_likelihood
</th>
<th style="text-align:right;">
cvl_crit
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
200
</td>
<td style="text-align:right;">
-30973.06
</td>
<td style="text-align:right;">
6.216744e+13
</td>
</tr>
<tr>
<td style="text-align:right;">
250
</td>
<td style="text-align:right;">
-19212.92
</td>
<td style="text-align:right;">
1.329681e+14
</td>
</tr>
<tr>
<td style="text-align:right;">
300
</td>
<td style="text-align:right;">
-11622.04
</td>
<td style="text-align:right;">
2.456196e+14
</td>
</tr>
<tr>
<td style="text-align:right;">
350
</td>
<td style="text-align:right;">
-7467.40
</td>
<td style="text-align:right;">
4.081420e+14
</td>
</tr>
<tr>
<td style="text-align:right;">
400
</td>
<td style="text-align:right;">
-4717.82
</td>
<td style="text-align:right;">
6.286203e+14
</td>
</tr>
<tr>
<td style="text-align:right;">
450
</td>
<td style="text-align:right;">
-4724.50
</td>
<td style="text-align:right;">
9.118642e+14
</td>
</tr>
<tr>
<td style="text-align:right;">
500
</td>
<td style="text-align:right;">
-4052.91
</td>
<td style="text-align:right;">
1.261851e+15
</td>
</tr>
<tr>
<td style="text-align:right;">
550
</td>
<td style="text-align:right;">
-4066.38
</td>
<td style="text-align:right;">
1.684041e+15
</td>
</tr>
<tr>
<td style="text-align:right;">
600
</td>
<td style="text-align:right;">
-4082.22
</td>
<td style="text-align:right;">
2.182688e+15
</td>
</tr>
<tr>
<td style="text-align:right;">
650
</td>
<td style="text-align:right;">
-4097.93
</td>
<td style="text-align:right;">
2.761617e+15
</td>
</tr>
<tr>
<td style="text-align:right;">
700
</td>
<td style="text-align:right;">
-4113.56
</td>
<td style="text-align:right;">
3.426765e+15
</td>
</tr>
</tbody>
</table>
<p>As one can see here, the cross-validation approach suggests a value between 400 and 500 meters, while the Cronie and Van Lieshout’s Criterion recommend a value between 250 and 300 meters.</p>
</div>
<div id="complementary-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#complementary-functions" class="anchor"></a>Complementary functions</h2>
<p>To define the sampling points on the network, some complementary functions are provided:</p>
<ul>
<li>
<code>lines_center</code> returns the center point of each line in a <em>SpatialLinesDataFrame</em>.</li>
<li>
<code>lixelize_lines</code> returns lixels obtained after dividing a <em>SpatialLinesDataFrame</em>.</li>
<li>
<code>lines_points_along</code> returns points at a specified distance along each lines in a <em>SpatialLinesDataFrame</em>.</li>
</ul>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-abramson1982bandwidth">
<p>Abramson, Ian S. 1982. “On Bandwidth Variation in Kernel Estimates-a Square Root Law.” <em>The Annals of Statistics</em>, 1217–23.</p>
</div>
<div id="ref-cronie2018non">
<p>Cronie, Ottmar, and Maria Nicolette Margaretha Van Lieshout. 2018. “A Non-Model-Based Approach to Bandwidth Selection for Kernel Estimators of Spatial Intensity Functions.” <em>Biometrika</em> 105 (2): 455–62.</p>
</div>
<div id="ref-okabe2012spatial">
<p>Okabe, Atsuyuki, and Kokichi Sugihara. 2012. <em>Spatial Analysis Along Networks: Statistical and Computational Methods</em>. John Wiley &amp; Sons.</p>
</div>
<div id="ref-sugihara2010simple">
<p>Sugihara, Kokichi, Toshiaki Satoh, and Atsuyuki Okabe. 2010. “Simple and Unbiased Kernel Function for Network Analysis.” In <em>2010 10th International Symposium on Communications and Information Technologies</em>, 827–32. IEEE.</p>
</div>
<div id="ref-xie2008kernel">
<p>Xie, Zhixiao, and Jun Yan. 2008. “Kernel Density Estimation of Traffic Accidents in a Network Space.” <em>Computers, Environment and Urban Systems</em> 32 (5): 396–406.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jeremy Gelb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
